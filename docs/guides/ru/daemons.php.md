daemons.php
===========

Структура файла конфигурации демонов.

```php
[
    'file-server' => [                          // Наименование настроек демона
        'component'       => 'file',            // Компонент
        'archive'         => true,              // Сохранять в архив
        'callback'        => [                  // Ссылки для обратного ответа
            'default' => 'http://localhost/',
        ],
        'child-processes' => 450,               // Максимальное кол-во потоков
        'max-threads'     => 5,                 // Максимальное кол-во потоков на группу задач
        'max-count'       => 100,               // Максимальное кол-во строк для отправки результатов
        'multi-instance'  => true,              // Режим демона
        'sleep'           => 5,                 // Время ожидания между повторами получения списка задач
        'extension'       => '',                // Расширение сохраняемого файла
        'directories'     => [                  // Директории для работы файлового демона
            'web'    => '/uploads/files',       // директория для подстановки в URL файла
            'source' => '@app/temp',            // директория для хранения временных файлов
            'target' => '@app',                 // директория для сохранения файлов
        ],
        'db'              => [                  // Настройки подключений к БД
            'default' => [                      // настройки подключения по умолчанию
                'driver' => 'redis',            // драйвер подключения
                'db'     => [                   // настройки для Yii2 компоненты подключения к БД
                    'class'    => 'yii\redis\Connection',
                    'hostname' => 'localhost',
                    'port'     => 6379,
                    'database' => 0,
                ]
            ],
            'config'  => [                      // настройки для компонент подключения [source, result, arcresult, jobs]
                'source' => [
                    'driver' => 'redis',
                    'db'     => [
                        'class'    => 'yii\redis\Connection',
                        'hostname' => 'localhost',
                        'port'     => 6379,
                        'database' => 0,
                    ]
                ],
            ],
            'merge'   => [                      // параметры для изменения подключения, если указаны настройки по умолчанию
                'result'    => [
                    'db' => [
                        'database' => 1,
                    ],
                ],
                'arcresult' => [
                    'db' => [
                        'database' => 2,
                    ],
                ],
                'jobs'      => [
                    'db' => [
                        'database' => 2,
                    ],
                ],
            ],
        ],
    ],
];
```

Обязательные параметры:
-----------------------

### Наименование настроек демона

```php
array 'file-server' = []
```

По умолчанию наименование настроек формируется из наименования класса, в частности это наименование можно получить из `FileServerDaemonController`.

Так же существует возможность принудительно указать наименование настроек путём указания значения свойства класса контроллера `$configAlias = 'file-server';`

### Настройки подключений к БД

```php
array 'db' = [
    'default' => [
        'driver' => 'redis',
        'db'     => [
            'class'    => 'yii\redis\Connection',
            'hostname' => 'localhost',
            'port'     => 6379,
            'database' => 0,
        ]
    ],
    'config'  => [
        'source' => [
            'driver' => 'redis',
            'db'     => [
                'class'    => 'yii\redis\Connection',
                'hostname' => 'localhost',
                'port'     => 6379,
                'database' => 0,
            ]
        ],
    ],
    'merge'   => [
        'result'    => [
            'db' => [
                'database' => 1,
            ],
        ],
        'arcresult' => [
            'db' => [
                'database' => 2,
            ],
        ],
        'jobs'      => [
            'db' => [
                'database' => 2,
            ],
        ],
    ],
];
```

Для каждой модели данных создаётся отдельное подключение (специфика работы RedisDB, чтобы избежать пересечения данных).

Для подключении к БД используется методика подключения в качестве компоненты Yii2.

При инициализации подключения производится добавление 4-х компонент с наименованием по формуле `filedaemon_` + {`source`|`result`|`arcresult`|`jobs`}.

Настройки могут быть указаны:
* *единые* (`default`)
* *индивидуальные*  (`config`)
* *наследуемые*  (`merge`)

#### настройки подключения по умолчанию (*единые*)

```php
array 'default' => [
    'driver' => 'redis',
    'db'     => [
        'class'    => 'yii\redis\Connection',
        'hostname' => 'localhost',
        'port'     => 6379,
        'database' => 0,
    ]
]
```

Базовые настройки подключения, которые могут быть изменены путём замены с помощью наследуемых настроек.

```php
string 'driver' = 'redis'
```

`driver` указывает на пространство имен, где располагаются модели данных.

В частности данная настройка означает, что модели располагаются в пространстве имён `\phantomd\filedaemon\db\redis\models\`.

```php
array 'db' = [
    'class'    => 'yii\redis\Connection',
    'hostname' => 'localhost',
    'port'     => 6379,
    'database' => 0,
]
```

`db` должен содержать настройки компоненты подключения в соответствии с документацией расширения Yii2.

#### настройки подключения (*индивидуальные*)

```php
array 'config' => [
    'source' => [
        'driver' => 'redis',
        'db'     => [
            'class'    => 'yii\redis\Connection',
            'hostname' => 'localhost',
            'port'     => 6379,
            'database' => 0,
        ]
    ],
]
```

Индивидуальные настройки подключения.

*Преоритетные настройки, все параметры обязательны!*

#### настройки подключения (*наследуемые*)

```php
array 'merge' => [
    'result' => [
        'db'     => [
            'database' => 1,
        ]
    ],
]
```

Наследуемые настройки подключения.

Если указаны настройки по умолчанию, то здесь указываются параметры, которые отличаются от базовых настроек.

В частности данная настройка означает, параметр `db[database]` должен быть изменён с базового значения `0` на `1`.

Не обязательные параметры:
--------------------------

### Компонент

```php
string 'component' = 'file'
```

Встроенные компоненты:
* **file** - класс компонента `\phantomd\filedaemon\FileProcessing`.
* **image** - класс компонента `\phantomd\filedaemon\ImageProcessing`.

Допускается указание другого класса. *Должен быть унаследован от* `\phantomd\filedaemon\FileProcessing`.

В параметр вписывается наименование класса с пространством имён, полностью (например так `\app\components\PdfProcessing`).

### Сохранять в архив

```php
boolean 'archive' = true
```

Архив необходим в том случае, если есть необходимость избежать повторной обработки полностью идентичного файла.

Идентичность файла проверяется путём получения MD5 хэша из строки: `object_id` + MD5 хэш из строки: ссылка на файл + объём файла в байтах.

Означает сохранять результаты в архив или нет.

### Ссылки для обратного ответа

```php
array 'callback' = [
    'default' => 'http://localhost/',
]
```

Здесь указываются ссылки для групп задач, куда будет отправлен результат обработки данных.

Данная настройка добавлена для ситуаций, когда при получении данных на обработку по API не указан параметр `callback`.

Если указано значение `default`, то будет добавляться для групп задач, для которых нет индивидуалной ссылки для отправки результатов

### Максимальное кол-во потоков

```php
integer 'child-processes' = 400
```

Указывается максимальное допустимое количество процессов демона, которое будет одновременно работать.

### Максимальное кол-во потоков на группу задач

```php
integer 'max-threads' = 1
```

Указывается максимальное допустимое количество процессов на группу задач, которое будет одновременно работать.

### Максимальное кол-во строк для отправки результатов

```php
integer 'max-count' = 100
```

Указывается максимальное допустимое количество строк для отправки результатов.

Эта настройка касается непосредственно ограничений на длинну строки HTTP POST.

Устанавливается индивидуально для машины, где работает демон и целевая машина, на которую будут отправляться результаты.
[php.ini](http://php.net/manual/ini.core.php#ini.post-max-size)

### Время ожидания между повторами получения списка задач

```php
integer 'sleep' = 60
```

Указывается время ожидания в секундах между итерациями получения списка задач.

### Расширение сохраняемого файла

```php
string 'extension' = ''
```

Указывается расширение для файла, который будет сохранён в результаты.

По умолчанию расширение файла берётся из результатов запроса по ссылке на источник.

### Директории для работы файлового демона

```php
array 'directories' = []
```

Список директорий для сохранения. Допустимо указывать путь с использованием псевдонимов Yii2.

При отсутствии указанных директорий, они создаются автоматически.

#### директория для подстановки в URL файла

```php
string 'web' = '/uploads/files'
```

Путь для относительной ссылки на результаты обработки.

#### директория для хранения временных файлов

```php
string 'source' = '@app/temp'
```
Директория для сохранения скаченных файлов по ссылке перед обработкой.

*Указывается абсолютный путь или псевдоним!*

#### директория для сохранения фалов

```php
string 'target' = '@app'
```

Директория для сохранения файлов после обработки.

Полный путь к файлу формируется по формуле `target` + `web` + `date('/Y/m/d/H/i/')` + имя файла

*Указывается абсолютный путь или псевдоним!*
